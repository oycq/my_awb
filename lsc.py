#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import numpy as np
import cv2
from typing import Tuple

def load_lsc_gain_map(height: int, width: int) -> np.ndarray:
    lsc = {
        "time": "2025-09-08 10:21:27",
        "sn": "112SN10B7X010X",
        "matrix": [7241,6315,6065,5803,5606,5289,5096,4866,4672,4453,4272,4124,3982,3912,3845,3800,3779,3787,3817,3946,4017,4110,4254,4421,4599,4794,5050,5251,5493,5799,6021,6244,6934,6260,5969,5730,5450,5161,4893,4607,4379,4128,3946,3764,3618,3503,3413,3348,3305,3308,3315,3341,3403,3512,3631,3741,3931,4116,4356,4594,4865,5125,5387,5687,5895,6088,5883,5627,5351,4997,4660,4381,4098,3836,3613,3426,3251,3122,3028,2965,2891,2854,2842,2863,2886,2940,3024,3113,3228,3408,3568,3809,4075,4340,4652,4928,5239,5507,5745,5547,5237,4887,4540,4203,3900,3615,3379,3159,2984,2845,2713,2631,2561,2506,2490,2476,2481,2519,2548,2620,2710,2818,2958,3127,3324,3556,3844,4131,4480,4808,5163,5406,5204,4840,4459,4097,3747,3432,3181,2962,2786,2611,2497,2394,2327,2262,2224,2189,2180,2188,2205,2253,2308,2381,2471,2599,2754,2916,3127,3384,3678,4017,4341,4708,5041,4754,4386,4019,3689,3338,3057,2837,2642,2475,2343,2226,2137,2064,2006,1970,1949,1945,1945,1966,1992,2052,2112,2208,2318,2439,2600,2790,3026,3274,3592,3939,4284,4609,4348,3997,3604,3270,2994,2752,2536,2368,2231,2111,2016,1917,1851,1812,1769,1751,1741,1749,1762,1792,1846,1903,1988,2087,2205,2344,2507,2715,2960,3243,3565,3926,4258,4011,3648,3280,2987,2705,2499,2316,2151,2029,1913,1818,1736,1672,1635,1604,1578,1574,1581,1596,1623,1664,1729,1798,1896,1994,2125,2294,2462,2670,2948,3231,3604,3958,3700,3339,3016,2716,2491,2295,2145,1978,1855,1752,1658,1581,1528,1490,1459,1441,1438,1437,1457,1484,1522,1569,1645,1733,1848,1956,2102,2258,2465,2689,2961,3312,3593,3461,3110,2788,2541,2322,2134,1981,1845,1714,1618,1530,1460,1411,1375,1345,1329,1334,1335,1346,1370,1407,1459,1520,1607,1699,1814,1947,2104,2285,2501,2747,3058,3374,3224,2914,2614,2379,2170,1997,1848,1721,1597,1502,1422,1361,1315,1286,1263,1243,1253,1245,1260,1282,1316,1363,1419,1495,1581,1685,1826,1967,2141,2338,2573,2860,3156,3071,2765,2470,2244,2050,1885,1740,1620,1503,1410,1344,1288,1247,1218,1198,1181,1181,1183,1191,1210,1246,1286,1337,1407,1494,1600,1724,1865,2022,2216,2441,2699,2977,2921,2648,2361,2138,1950,1792,1652,1536,1432,1345,1287,1228,1191,1165,1136,1127,1122,1125,1131,1160,1193,1229,1284,1352,1425,1524,1642,1781,1933,2116,2334,2583,2840,2805,2555,2284,2069,1883,1735,1593,1482,1380,1307,1246,1196,1150,1122,1089,1073,1069,1077,1089,1116,1152,1194,1242,1304,1378,1471,1585,1716,1875,2052,2250,2495,2740,2734,2494,2249,2025,1839,1692,1548,1440,1348,1274,1217,1170,1126,1091,1065,1046,1041,1046,1059,1084,1121,1162,1213,1275,1344,1441,1557,1676,1828,2005,2208,2453,2689,2702,2443,2220,1997,1817,1664,1532,1419,1334,1264,1205,1151,1110,1078,1046,1029,1025,1030,1043,1068,1107,1149,1198,1263,1329,1415,1534,1658,1815,1995,2191,2433,2659,2695,2439,2216,2010,1817,1664,1542,1429,1332,1261,1204,1152,1107,1072,1045,1028,1024,1027,1044,1069,1105,1150,1201,1261,1329,1420,1531,1660,1812,1988,2196,2426,2660,2723,2464,2221,2006,1838,1679,1545,1435,1346,1273,1220,1162,1116,1081,1053,1039,1035,1039,1053,1081,1121,1166,1214,1267,1339,1431,1546,1679,1835,2020,2220,2456,2696,2774,2514,2262,2061,1868,1716,1581,1457,1372,1302,1244,1189,1144,1112,1080,1064,1060,1066,1082,1108,1142,1185,1230,1295,1370,1468,1580,1712,1869,2050,2267,2493,2772,2861,2595,2324,2111,1921,1769,1626,1511,1415,1339,1283,1223,1184,1156,1122,1105,1100,1110,1126,1152,1187,1223,1269,1339,1413,1511,1630,1770,1937,2120,2333,2587,2839,2964,2687,2422,2188,2000,1835,1688,1568,1467,1386,1328,1273,1232,1198,1173,1157,1152,1161,1176,1199,1234,1271,1326,1390,1479,1575,1711,1851,2009,2208,2424,2696,2972,3101,2839,2558,2311,2099,1923,1780,1655,1545,1460,1394,1335,1289,1267,1232,1224,1223,1225,1237,1263,1293,1335,1392,1467,1554,1670,1801,1943,2123,2324,2552,2838,3119,3301,2999,2694,2445,2225,2039,1887,1760,1646,1555,1484,1414,1363,1338,1311,1291,1287,1296,1309,1337,1372,1416,1484,1560,1661,1777,1907,2056,2246,2460,2723,3012,3317,3536,3205,2879,2605,2388,2186,2026,1893,1783,1672,1592,1520,1463,1426,1399,1385,1380,1381,1403,1440,1472,1525,1596,1690,1786,1909,2049,2207,2403,2625,2886,3209,3530,3826,3445,3111,2818,2565,2364,2189,2045,1925,1817,1732,1654,1594,1557,1523,1513,1495,1504,1527,1558,1604,1667,1732,1829,1928,2069,2218,2392,2606,2842,3122,3466,3821,4173,3763,3395,3074,2814,2578,2391,2232,2094,1996,1904,1827,1753,1703,1672,1652,1647,1655,1675,1709,1763,1831,1912,2005,2110,2250,2413,2604,2829,3102,3419,3796,4165,4503,4109,3719,3381,3082,2844,2625,2473,2314,2188,2090,2005,1930,1893,1854,1831,1827,1833,1858,1903,1957,2018,2095,2209,2341,2483,2659,2864,3112,3395,3751,4124,4526,4899,4520,4130,3755,3445,3152,2911,2718,2575,2426,2317,2227,2152,2105,2066,2043,2037,2047,2068,2117,2169,2255,2352,2461,2580,2763,2963,3186,3479,3788,4162,4563,4904,5312,4926,4575,4201,3854,3556,3284,3065,2876,2713,2604,2510,2416,2366,2321,2286,2287,2303,2327,2372,2439,2529,2630,2767,2913,3094,3332,3597,3893,4250,4637,4968,5345,5698,5354,5021,4655,4323,3994,3714,3479,3242,3075,2961,2845,2744,2679,2635,2602,2592,2605,2639,2684,2755,2855,2975,3137,3301,3523,3787,4044,4384,4736,5104,5463,5743,6059,5831,5464,5157,4845,4505,4226,3962,3736,3569,3401,3255,3146,3064,3009,2971,2962,2983,3011,3070,3164,3273,3401,3591,3781,4012,4290,4588,4871,5210,5517,5860,6119,6347,6150,5886,5618,5316,5037,4767,4507,4295,4101,3927,3764,3627,3542,3461,3426,3438,3451,3484,3539,3641,3772,3926,4117,4340,4568,4809,5133,5386,5695,5979,6184,6421,6903,6426,6217,6007,5794,5501,5251,5033,4780,4606,4422,4258,4139,4062,3983,3946,3931,3947,3986,4056,4152,4298,4445,4632,4849,5098,5286,5567,5831,6091,6271,6473,6914],
        "xSize": [34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34,34],
        "ySize": [40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40],  # 假设为32个40，以匹配33x33网格
        "version": "0.0",
        "checksum": 2853006
    }

    arr = np.asarray(lsc["matrix"], dtype=np.float32)
    # 校验长度是否为 33x33
    if arr.size != 33 * 33:
        # 若提供的数组更长，尽量截断前 1089 个；否则报错
        if arr.size > 33 * 33:
            arr = arr[:33 * 33]
        else:
            raise ValueError(f"LSC matrix size {arr.size} != 1089 (33x33)")

    grid = arr.reshape(33, 33)  # (gy, gx)
    # 转为真实增益（1.0 基准）
    gain_grid = grid / 1024.0

    # 将 33x33 插值到 (height x width)
    # 这里使用双三次插值，节点等距覆盖整幅图（32 个间隔）
    gain_map = cv2.resize(gain_grid, (width, height), interpolation=cv2.INTER_CUBIC)

    return gain_map.astype(np.float32)


def apply_lsc(img):
    lsc_gain_map = load_lsc_gain_map(img.shape[0], img.shape[1])
    img = img * lsc_gain_map
    return img